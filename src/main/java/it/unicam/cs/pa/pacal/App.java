/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package it.unicam.cs.pa.pacal;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.*;
import java.util.function.Consumer;

/**
 *
 */
public class App<T extends CalcState> {

    private Map<String, Consumer<? super T>> commands;
    private T state;

    public static final Consumer<CalcState> SUM_FUNCTION = c -> c.setValue(c.getValue2()+c.getValue1());
    public static final Consumer<CalcState> DIF_FUNCTION = c -> c.setValue(c.getValue2()-c.getValue1());
    public static final Consumer<CalcState> MUL_FUNCTION = c -> c.setValue(c.getValue2()*c.getValue1());
    public static final Consumer<CalcState> DIV_FUNCTION = c -> c.setValue(c.getValue2()/c.getValue1());

    public App( Map<String, Consumer<? super T>> commands, T state ) {
        this.commands = commands;
        this.commands.put("help",s -> printCommands());
        this.state = state;
    }

    public static void main(String[] args) throws IOException {
        //createBaseCalc().start();
        createDoubleMemApp().start();
    }

    public void start() throws IOException {
        hello();
        BufferedReader reader = new BufferedReader(new InputStreamReader(System.in));
        while (state.isOn()) {
            printState();
            System.out.print(" > ");
            System.out.flush();
            String command = reader.readLine();
            processCommand(command);
        }
        printGoodbye();
    }

    private void printGoodbye() {
        System.out.println("\n\nThank you for having used our calculator!");
        System.out.println("See you next time!\n\n");
    }

    private void hello() {
        System.out.println("******************************");
        System.out.println("*         PACALC 0.1         *");
        System.out.println("******************************");

    }

    private void printCommands() {
        TreeSet<String> words = new TreeSet<>(commands.keySet());
        String[] wordsArray = words.toArray(new String[] {});
        System.out.println("Commands: "+ Arrays.toString(wordsArray));
    }

    private void processCommand(String command) {
        try {
            double value = Double.parseDouble(command);
            state.setValue(value);
        } catch (NumberFormatException e) {
            Consumer<? super T> action = commands.get(command);
            if (action == null) {
                System.err.println("Unknown command: "+command);
            } else {
                action.accept(state);
            }
        }
    }

    public void printState() {
        System.out.println(state.toString());
    }

    public static App<CalcState> createBaseCalc() {
        HashMap<String,Consumer<? super CalcState>> commands = new HashMap<>();
        commands.put("+",SUM_FUNCTION);
        commands.put("-",DIF_FUNCTION);
        commands.put("/",DIV_FUNCTION);
        commands.put("*",MUL_FUNCTION);
        commands.put("square",App::square);//s -> App.square(s)
        commands.put("exit",CalcState::turnOff);
        commands.put("store",CalcState::store);
        commands.put("call",s -> s.setValue(s.getMem()));
        commands.put("clear",CalcState::reset);
        commands.put("delete",s -> s.setValue(0.0));
        return new App<CalcState>(commands,new CalcState());
    }

    public static App<DoubleMemoryCalcState> createDoubleMemApp() {
        HashMap<String, Consumer<? super DoubleMemoryCalcState>> commands = new HashMap<>();
        commands.put("+",App.SUM_FUNCTION);
        commands.put("-",App.DIF_FUNCTION);
        commands.put("/",App.DIV_FUNCTION);
        commands.put("*",App.MUL_FUNCTION);
        commands.put("square",App::square);//s -> App.square(s)
        commands.put("exit",CalcState::turnOff);
        commands.put("store1",DoubleMemoryCalcState::storeToMem1);
        commands.put("store2",DoubleMemoryCalcState::storeToMem2);
        commands.put("call",s -> s.setValue(s.getMem()));
        commands.put("clear",CalcState::reset);
        commands.put("delete",s -> s.setValue(0.0));
        commands.put("log",s -> s.setValue(Math.log(s.getValue1())));
        commands.put("sin",s -> s.setValue(Math.sin(s.getValue1())));
        return new App<DoubleMemoryCalcState>(commands,new DoubleMemoryCalcState());
    }

    public static void square( CalcState s ) {
        double value = s.getValue1();
        s.setValue(value*value);
    }

}
